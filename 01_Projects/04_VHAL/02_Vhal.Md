üîπ 1. Java App Layer (Car Apps)
======================================================================================
Android Automotive apps use CarPropertyManager to interact with vehicle info.


CarPropertyManager carPropMgr = car.createCarPropertyManager();
carPropMgr.getProperty(...); // speed, RPM, HVAC


üîπ 2. Car Service (Java Framework Layer)
======================================================================================
Lives in packages/services/Car

It abstracts the vehicle features into proper APIs.

Talks to Vehicle HAL via JNI.

Example:
CarPowerManagementService, CarSensorService, etc.

üîπ 3. JNI Layer: VehicleHalManager.cpp
======================================================================================
Bridges Java and native code:

Loads the AIDL Vehicle HAL service

Translates property requests to C++ calls


android::sp<IVehicle> mVehicle;
mVehicle->get(...);  // Calls into HAL
üîπ 4. Vehicle HAL AIDL Interface
======================================================================================
Defined in:
hardware/interfaces/automotive/vehicle/aidl/android/hardware/automotive/vehicle/IVehicle.aidl

Key Functions:

IVehicle {
    oneway void setValue(VehiclePropValue value);
    VehiclePropValue getValue(int32 propId);
    ...
}
It defines vehicle property IDs, status, access type, and more.

üîπ 5. Vehicle HAL C++ Implementation
======================================================================================
Code:
`hardware/interfaces/automotive/vehicle/aidl/default/DefaultVehicleHal.cpp`

Responsibilities:

Maintains property state in memory or fetches via hardware.

Maps prop IDs like:
    VehicleProperty::CURRENT_GEAR
    VehicleProperty::HVAC_FAN_SPEED
    VehicleProperty::ENGINE_RPM

Uses VehiclePropValue structure to encode values.

Sample:

VehiclePropValue DefaultVehicleHal::getValue(...) {
    switch (propId) {
        case CURRENT_GEAR:
            return constructGearProp(3); // Drive
        ...
    }
}


üîπ 6. Hardware Interface (CAN / Serial / BMS)
======================================================================================
Interacts with hardware using:

CAN bus (via SocketCAN or MCP2515)

UART (MCU-to-Android)

I2C (BMS or sensors)

Data Parsing Layer:

May use custom protocol to read vehicle messages.

Implements message framing, checksum, etc.

Example:


int canSocket = socket(PF_CAN, SOCK_RAW, CAN_RAW);
bind(canSocket, ...);
read(canSocket, &frame, sizeof(frame));
parseCAN(frame);

üîπ 7. Device Driver Layer (Optional)
======================================================================================
Some systems may use character device drivers: /dev/vehicle

HAL can open this and communicate with MCU directly.


int fd = open("/dev/vehicle", O_RDWR);
write(fd, command, len);
read(fd, response, len);

üîê 8. SELinux + Service Registration
======================================================================================
AIDL HAL service is registered as:

    android.hardware.automotive.vehicle.IVehicle/default

Must be listed in:

- `vintf/manifest.xml`
- rc file to start with system:

    service vehicle-hal /vendor/bin/hw/android.hardware.automotive.vehicle-service

SELinux rules:

- Define `hal_vehicle_default` context.
- Allow access to `/dev/can0`, `/dev/vehicle`, etc.

üí° Example Flow: App Reads Vehicle Speed
======================================================================================

- Java App  
  ‚Üì  
- CarPropertyManager.get(SPEED)  
  ‚Üì  
- CarSensorManager ‚Üí JNI  
  ‚Üì  
- IVehicle.get(SPEED)  
  ‚Üì  
- Vehicle HAL C++ ‚Üí parses cache or hardware  
  ‚Üì  
- Returns `VehiclePropValue { propId: SPEED, value: 45.0 }`  
  ‚Üì  
- App displays speed


üîÅ Periodic Update or Subscription
======================================================================================
Vehicle HAL supports subscriptions:

Framework subscribes to a prop (like speed).

HAL pushes updates via `IVehicleCallback`:

üìã Common VehicleProp IDs
======================================================================================

| Prop ID              | Type    | Example Use           |
|----------------------|---------|-----------------------|
| PERF_VEHICLE_SPEED   | float   | Car speed (km/h)      |
| HVAC_FAN_SPEED       | int     | Fan speed             |
| GEAR_SELECTION       | int     | PRND gear info        |
| DOOR_POSITIONS       | int[]   | Door open/close       |
| IGNITION_STATE       | enum    | OFF/ACC/RUN           |

See:
android.hardware.automotive.vehicle@2.0/types.hal

‚úÖ Summary (Block-wise)
======================================================================================

Apps (Java)  ‚Üí  CarService  ‚Üí  JNI  ‚Üí  IVehicle AIDL  ‚Üí  HAL Impl (C++)  ‚Üí  ECU / Driver
      ‚Üë             ‚Üë             ‚Üë            ‚Üë                ‚Üë
  Subscription   Subscription   Subscription   get/set   Hardware communication (CAN/UART)



üîß Debugging Tools
======================================================================================

| Tool             | Use                                      |
|------------------|------------------------------------------|
| lshal            | List HALs and their status               |
| adb logcat       | Framework + HAL logs                     |
| dumpsys car      | Check car property manager, speed, HVAC  |
| vhal_test_client | Test vehicle HAL APIs                    |